# 가스 자동 추정 + 20% 버퍼 테스트 가이드

## 구현 내용

`submitVote()` 함수에서:

1. **가스 자동 추정**: `contract.vote.estimateGas()` 사용
2. **20% 버퍼 추가**: 추정값 × 1.2
3. **콘솔 로그**: 추정값, 버퍼 포함값, 실제 사용량 출력

## 테스트 방법

### 1. 기본 테스트 (정상 케이스)

#### 준비사항

- MetaMask에서 Sepolia 네트워크 연결
- Sepolia 테스트넷 ETH 보유 (가스비용용)
- 투표 가능한 상태

#### 테스트 절차

1. **브라우저 개발자 도구 열기**

   - F12 또는 우클릭 → 검사
   - Console 탭 선택

2. **투표 실행**

   - 투표 상세 페이지에서 선택지 선택
   - "투표하기 (ZKP 생성)" 버튼 클릭
   - MetaMask 트랜잭션 승인

3. **콘솔 로그 확인**

   ```
   추정된 가스: 500000
   버퍼 포함 가스: 600000
   트랜잭션 전송됨: 0x...
   실제 사용된 가스: {
     추정값: "500000",
     버퍼포함: "600000",
     실제사용: "485000",
     절약량: "115000"
   }
   ```

4. **검증 포인트**
   - ✅ 추정값이 정상적으로 출력되는가?
   - ✅ 버퍼 포함값 = 추정값 × 1.2 인가?
   - ✅ 실제 사용량이 버퍼 포함값보다 작은가?
   - ✅ 트랜잭션이 성공적으로 완료되는가?

### 2. 가스 부족 시뮬레이션 테스트

#### 목적

버퍼가 충분한지 확인

#### 방법

1. **가스 추정값 확인**

   - 콘솔에서 추정값 기록 (예: 500000)

2. **수동으로 낮은 가스 설정** (임시 테스트용)

   ```typescript
   // src/lib/contract.ts에서 임시로 수정
   const gasWithBuffer = estimatedGas // 버퍼 없이 테스트
   ```

3. **트랜잭션 실행**

   - 가스 부족 에러 발생 여부 확인

4. **원래대로 복구**
   - 버퍼 포함 코드로 되돌림

### 3. 다양한 Proof 크기 테스트

#### 목적

Proof 크기에 따른 가스 사용량 변화 확인

#### 테스트 케이스

1. **작은 Proof** (간단한 투표)
   - 가스 추정값 기록
2. **큰 Proof** (복잡한 ZKP)
   - 가스 추정값 기록
   - 비교 분석

### 4. 네트워크 혼잡 상황 테스트

#### 목적

네트워크 상태에 따른 가스 추정 정확도 확인

#### 방법

1. **평상시 테스트**

   - 가스 추정값 기록

2. **네트워크 혼잡 시간대 테스트**
   - Sepolia 네트워크가 바쁜 시간대에 테스트
   - 가스 추정값과 실제 사용량 비교

### 5. 에러 케이스 테스트

#### 테스트 시나리오

1. **가스 추정 실패**

   ```javascript
   // 예상 동작: 에러 메시지 출력 및 트랜잭션 중단
   ```

2. **트랜잭션 실행 중 가스 부족**
   ```javascript
   // 예상 동작: 트랜잭션 실패, 에러 메시지 표시
   ```

## 콘솔 로그 예시

### 정상 케이스

```
🔹 증명 생성 시작: { vote: 1 }
🎉 Proof 생성 완료: { a: [...], b: [...], c: [...], inputSignals: [...] }
추정된 가스: 485234
버퍼 포함 가스: 582280
트랜잭션 전송됨: 0x1234...abcd
사용된 가스: {
  추정값: "485234",
  버퍼포함: "582280",
  실제사용: "대기중...",
}
트랜잭션 확인됨: { ... }
실제 사용된 가스: {
  추정값: "485234",
  버퍼포함: "582280",
  실제사용: "482150",
  절약량: "100130"
}
```

### 에러 케이스

```
추정된 가스: 485234
버퍼 포함 가스: 582280
❌ 투표 트랜잭션 실패: Error: execution reverted
```

## 검증 체크리스트

- [ ] 가스 추정이 정상적으로 작동하는가?
- [ ] 20% 버퍼가 올바르게 계산되는가? (추정값 × 1.2)
- [ ] 실제 사용량이 버퍼 포함값보다 작은가?
- [ ] 트랜잭션이 성공적으로 완료되는가?
- [ ] 콘솔 로그가 명확하게 출력되는가?
- [ ] 가스 부족 에러가 발생하지 않는가?
- [ ] 다양한 Proof 크기에서도 정상 작동하는가?

## 주의사항

1. **가스 가격 변동**: Sepolia 테스트넷의 가스 가격은 변동될 수 있습니다.
2. **네트워크 상태**: 네트워크가 혼잡하면 가스 추정이 부정확할 수 있습니다.
3. **Proof 크기**: ZKP Proof의 크기에 따라 가스 사용량이 달라질 수 있습니다.
4. **최소 가스**: 버퍼를 추가해도 네트워크 상황에 따라 부족할 수 있습니다 (드물지만 가능).

## 문제 해결

### 가스 추정 실패

- 컨트랙트 호출이 실패하는 경우 (예: 이미 투표함)
- 네트워크 연결 문제
- 컨트랙트 주소 오류

### 가스 부족 에러

- 버퍼를 30%로 증가 고려
- 네트워크 상태 확인
- Proof 크기 최적화 검토
